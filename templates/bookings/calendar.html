{% extends 'bookings/base.html' %}
{% load static %}

{% block title %}Calendar | Sky Salon and Beauty{% endblock %}

{% block content %}
<section class="calendar-section reveal">
    <h2>Book by availability</h2>

    <form method="get" class="calendar-form" id="availability-form">
        <input type="hidden" name="month" value="{{ month_start|date:'Y-m' }}">
        <div class="form-row">
            <label for="worker">1. Choose a stylist</label>
            <select name="worker" id="worker" required>
                <option value="">Choose a stylist...</option>
                {% for w in workers %}
                <option value="{{ w.id }}" {% if worker and w.id == worker.id %}selected{% endif %}>{{ w.full_name }}</option>
                {% endfor %}
            </select>
        </div>

        {% if worker %}
        <div class="form-row">
            <label for="service">2. Service for {{ worker.full_name }}</label>
            <select name="service" id="service" required>
                <option value="">Choose a service...</option>
                {% for svc in services %}
                <option value="{{ svc.id }}" {% if selected_service and svc.id == selected_service.id %}selected{% endif %}>
                    {{ svc.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <div class="form-row actions">
            <button type="submit" class="btn btn-primary">Show calendar</button>
        </div>
    </form>

    {% if worker and selected_service and not selected_date %}
    <div class="calendar-nav">
        <a class="btn" href="?worker={{ worker.id }}&service={{ selected_service.id }}&month={{ prev_month|date:'Y-m' }}">◀ {{ prev_month|date:"F Y" }}</a>
        <div class="month-label">{{ month_start|date:"F Y" }}</div>
        <a class="btn" href="?worker={{ worker.id }}&service={{ selected_service.id }}&month={{ next_month|date:'Y-m' }}"> {{ next_month|date:"F Y" }} ▶</a>
    </div>

    <div class="legend">
        <span class="dot available"></span> Green: at least one slot fits the service
        <span class="dot full"></span> Red: fully booked for this service
    </div>

    <div class="month-grid">
        <div class="weekday">Mon</div><div class="weekday">Tue</div><div class="weekday">Wed</div><div class="weekday">Thu</div><div class="weekday">Fri</div><div class="weekday">Sat</div><div class="weekday">Sun</div>
        {% for week in calendar_days %}
            {% for day in week %}
                {% if day.in_month %}
                    {% if day.status == 'available' %}
                        <a class="day available" href="?worker={{ worker.id }}&service={{ selected_service.id }}&month={{ month_start|date:'Y-m' }}&date={{ day.date|date:'Y-m-d' }}">{{ day.date.day }}</a>
                    {% elif day.status == 'full' %}
                        <div class="day full">{{ day.date.day }}</div>
                    {% elif day.status == 'past' %}
                        <div class="day past">{{ day.date.day }}</div>
                    {% else %}
                        <div class="day idle">{{ day.date.day }}</div>
                    {% endif %}
                {% else %}
                    <div class="day spacer"></div>
                {% endif %}
            {% endfor %}
        {% endfor %}
    </div>
    {% elif not worker or not selected_service %}
    <p class="hint">Select a worker and service to see the availability calendar.</p>
    {% endif %}

    {% if selected_date and worker and selected_service %}
    <div class="selected-date-box">
        <div class="selected-date-text">
            Date: {{ selected_date|date:"F j, Y" }} for {{ worker.full_name }} ({{ selected_service.name }})
        </div>
        <a class="btn" href="?worker={{ worker.id }}&service={{ selected_service.id }}&month={{ month_start|date:'Y-m' }}">Change date</a>
    </div>

    <div class="time-slots">
        <h3>Times on {{ selected_date|date:"F j, Y" }}</h3>
        {% if selected_slots %}
        <div class="slots-grid">
            {% for slot in selected_slots %}
                {% if slot.available %}
                <a class="time-slot available" href="{% url 'book' %}?worker={{ worker.id }}&service={{ selected_service.id }}&date={{ selected_date|date:'Y-m-d' }}&time={{ slot.time }}">
                    <span class="time">{{ slot.time }}</span>
                    <span class="status">Free – book</span>
                </a>
                {% else %}
                <div class="time-slot busy">
                    <span class="time">{{ slot.time }}</span>
                    <span class="status busy-text">Busy</span>
                </div>
                {% endif %}
            {% endfor %}
        </div>
        {% else %}
        <p class="hint">No free times remain that fit this service duration.</p>
        {% endif %}
    </div>
    {% endif %}
</section>

<style>
.calendar-section {
    background: var(--white);
    border: 1px solid #eee;
    padding: 24px;
    border-radius: 12px;
    margin-bottom: 24px;
}

.calendar-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 16px;
    align-items: end;
    margin-bottom: 16px;
}

.calendar-form .actions {
    display: flex;
    align-items: flex-end;
}

.legend {
    display: flex;
    gap: 16px;
    align-items: center;
    margin: 12px 0 16px;
    font-size: 14px;
}
.dot {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 6px;
}
.dot.available { background:#4caf50; }
.dot.full { background:#f44336; }

.calendar-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 12px 0 8px;
    gap: 12px;
}
.month-label {
    font-weight: 700;
    font-size: 18px;
}

.month-grid {
    display: grid;
    grid-template-columns: repeat(7, minmax(120px, 1fr));
    gap: 8px;
    margin-bottom: 24px;
}
.weekday {
    font-weight: 700;
    text-align: center;
    padding: 6px;
}
.day {
    min-height: 90px;
    border-radius: 10px;
    border: 2px solid #eee;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 18px;
    text-decoration: none;
    color: inherit;
}
.day.available {
    background: #e7f6e7;
    border-color: #4caf50;
    color: #1b5e20;
}
.day.available:hover { box-shadow: 0 8px 20px rgba(76,175,80,.25); }
.day.full {
    background: #fde8e8;
    border-color: #f44336;
    color: #b71c1c;
}
.day.past {
    opacity: 0.5;
}
.day.idle {
    background: #f8f9fb;
}
.day.spacer {
    visibility: hidden;
}

.selected-date-box {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    margin: 16px 0;
    border-radius: 10px;
    border: 1px solid #eee;
    background: #f8f9fb;
    font-weight: 600;
}

.time-slots h3 {
    margin-bottom: 12px;
}

.slots-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 10px;
    margin-bottom: 16px;
}

.time-slot {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 14px;
    border-radius: 10px;
    border: 2px solid;
    text-decoration: none;
}

.time-slot.available {
    background: #e7f6e7;
    border-color: #4caf50;
    color: #1b5e20;
}

.time-slot.busy {
    background: #fde8e8;
    border-color: #f44336;
    color: #b71c1c;
}

.time {
    font-weight: 700;
    font-size: 15px;
}

.hint {
    color: #666;
}

@media (max-width: 768px) {
    .month-grid {
        grid-template-columns: repeat(7, minmax(52px, 1fr));
    }
    .day { min-height: 64px; font-size: 15px; }
}
</style>

<script>
(function(){
  const form = document.getElementById('availability-form');
  const workerSelect = document.getElementById('worker');
  const serviceSelect = document.getElementById('service');
  if(workerSelect){
    workerSelect.addEventListener('change', function(){
      if(!this.value){ return; }
      form.querySelector('input[name="month"]').value = '';
      form.submit();
    });
  }
  if(serviceSelect){
    serviceSelect.addEventListener('change', function(){
      form.submit();
    });
  }
})();
</script>
{% endblock %}

